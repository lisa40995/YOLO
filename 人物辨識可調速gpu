import cv2
import torch
import time
from ultralytics import YOLO

# è¼‰å…¥ YOLOv8 æ¨¡å‹ (ä½¿ç”¨æœ€å°çš„ nano ç‰ˆæœ¬)
model = YOLO('yolov8n.pt')

# å¼·åˆ¶ä¸Ÿåˆ° GPU (å¦‚æœæœ‰çš„è©±)
device = "cuda" if torch.cuda.is_available() else "cpu"
model.to(device)
print(f"âœ… ä½¿ç”¨çš„è£ç½®: {device}")

# è®€å–å½±ç‰‡æª”
video_path = "C:\\Users\\lisa4\\vsvideo\\v4.mp4" # è«‹ç¢ºèªæ‚¨çš„è·¯å¾‘æ­£ç¢º
cap = cv2.VideoCapture(video_path)

if not cap.isOpened():
    print("âŒ å½±ç‰‡è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆåç¨±æˆ–è·¯å¾‘æ­£ç¢º")
    exit()

# ç²å–å½±ç‰‡åŸå§‹ FPS å’Œè§£æåº¦
original_fps = cap.get(cv2.CAP_PROP_FPS)
print(f"ğŸ¬ å½±ç‰‡åŸå§‹ FPS: {original_fps:.2f}")

# è¨­å®šæ¨¡å‹æ¨ç†çš„è¼¸å…¥å½±åƒå°ºå¯¸ï¼ˆå¯èª¿æ•´ï¼é€™æ˜¯æé«˜é€Ÿåº¦çš„é—œéµï¼‰
# é è¨­ç‚º 640ï¼Œæ‚¨å¯ä»¥å˜—è©¦æ›´å°çš„å€¼ï¼Œä¾‹å¦‚ 320 æˆ– 480
INFERENCE_IMG_SIZE = 640
print(f"ğŸ“ æ¨¡å‹è¼¸å…¥å°ºå¯¸: {INFERENCE_IMG_SIZE}x{INFERENCE_IMG_SIZE}")


paused = False
window_name = "YOLOv8 Object Tracking"
cv2.namedWindow(window_name, cv2.WINDOW_NORMAL)

while True:
    start_time = time.time()  # è¨˜éŒ„æ¯å¹€é–‹å§‹æ™‚é–“

    if not paused:
        ret, frame = cap.read()
        if not ret:
            # å½±ç‰‡æ’­æ”¾çµæŸ
            print("ğŸ¥ å½±ç‰‡æ’­æ”¾çµæŸ")
            break
            
        # æ ¸å¿ƒé‹ç®—ï¼šé€²è¡Œç›®æ¨™è¿½è¹¤
        # åŠ å…¥ imgsz åƒæ•¸ä¾†æ§åˆ¶æ¨ç†é€Ÿåº¦
        results = model.track(frame, 
                              classes=[0], # åƒ…è¿½è¹¤ 'person'
                              tracker='bytetrack.yaml', 
                              conf=0.6,
                              imgsz=INFERENCE_IMG_SIZE)

        # ç•«æ¡† (ä½¿ç”¨ result.boxes è³‡è¨Šæ‰‹å‹•ç¹ªè£½)
        for result in results:
            if result.boxes.id is not None:
                boxes = result.boxes.xyxy.cpu().numpy().astype(int)
                track_ids = result.boxes.id.cpu().numpy().astype(int)
                
                for box, track_id in zip(boxes, track_ids):
                    x1, y1, x2, y2 = box
                    # ç¶ è‰²æ¡†ç·š
                    color = (0, 255, 0)
                    cv2.rectangle(frame, (x1, y1), (x2, y2), color, 2)
                    cv2.putText(frame, f"ID: {track_id}", (x1, y1 - 10),
                                cv2.FONT_HERSHEY_SIMPLEX, 0.5, color, 2)

    # ---------------- è¨ˆç®—ä¸¦å°å‡º FPS ----------------
    end_time = time.time()
    elapsed_time = end_time - start_time
    # å¯¦éš›è™•ç†é€Ÿåº¦ (Processing FPS)
    processing_fps = 1 / elapsed_time
    
    # åœ¨ç•«é¢å·¦ä¸Šæ–¹é¡¯ç¤ºè™•ç†é€Ÿåº¦ (ç´…è‰²)
    cv2.putText(frame, f"Proc FPS: {processing_fps:.2f}", (20, 40),
                cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 0, 255), 2)
    
    # é¡¯ç¤ºåŸå§‹å½±ç‰‡ç›®æ¨™ FPS (è—è‰²)
    cv2.putText(frame, f"Orig FPS: {original_fps:.2f}", (20, 80),
                cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 0, 0), 2)
    # ------------------------------------------------

    cv2.imshow(window_name, frame)

    # **æ’­æ”¾é‚è¼¯å„ªåŒ–ï¼š**
    # é€™è£¡å°‡ delay è¨­ç‚º 1ï¼Œè¡¨ç¤ºç›¡å¯èƒ½å¿«åœ°åˆ·æ–°ç•«é¢ (åªç­‰ 1ms)ã€‚
    # é€™æ¨£å½±ç‰‡æ’­æ”¾é€Ÿåº¦å°±ç­‰æ–¼æ‚¨çš„ 'Proc FPS'ï¼Œé¿å…äº†å¡é “æ„Ÿã€‚
    key = cv2.waitKey(15 if not paused else 0) & 0xFF 
    
    if key == ord(' '): # æŒ‰ç©ºç™½éµæš«åœ/ç¹¼çºŒ
        paused = not paused
    if key == ord('q'): # æŒ‰ 'q' éµé€€å‡º
        break


cap.release()
cv2.destroyAllWindows()
print("ç¨‹å¼åŸ·è¡ŒçµæŸï¼Œè³‡æºå·²é‡‹æ”¾ã€‚")
